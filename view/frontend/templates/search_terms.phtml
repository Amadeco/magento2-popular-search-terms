<?php
/**
 * Amadeco PopularSearchTerms Module
 *
 * @category   Amadeco
 * @package    Amadeco_PopularSearchTerms
 * @author     Ilan Parmentier
 */

use Amadeco\PopularSearchTerms\ViewModel\SearchTerms;
use Magento\Framework\View\Element\Template;
use Magento\Framework\View\Helper\SecureHtmlRenderer;

/**
 * @var Template $block
 * @var SecureHtmlRenderer $secureRenderer
 * @var SearchTerms $viewModel
 */

// Retrieve ViewModel
$viewModel = $block->getData('view_model');
?>
<?php if ($viewModel && $viewModel->isEnabled()): ?>
    <div class="block block-search-terms">
        <div class="block-title">
            <strong role="heading" aria-level="2"><?= $block->escapeHtml(__('Search Terms')) ?></strong>
        </div>
        <div class="block-content">
            <div id="amadeco-search-terms" data-bind="scope: 'search-terms'" class="amadeco-search-terms">
                </div>
        </div>
    </div>

    <script type="text/x-magento-init">
    {
        "#amadeco-search-terms": {
            "Magento_Ui/js/core/app": <?= /* @noEscape */ $block->getJsLayout() ?>
        }
    }
    </script>

    <?php
    // Get configuration values from block arguments to pass to ViewModel
    $maxRecent = (int)($block->getData('max_recent_searches') ?? 5);
    $formId = (string)($block->getData('search_form_id') ?? 'search_mini_form');
    $inputName = (string)($block->getData('search_input_name') ?? 'q');
    $storageKey = (string)($block->getData('storage_key') ?? 'recent-searches');
    
    $jsonConfig = /* @noEscape */ $viewModel->getSerializedSearchTermsConfig($maxRecent, $formId, $inputName, $storageKey);
    
    $scriptString = <<<script
        window.searchTermsConfig = {$jsonConfig};
    script;
    ?>
    <?= /* @noEscape */ $secureRenderer->renderTag('script', [], $scriptString, false); ?>
<?php endif; ?>
